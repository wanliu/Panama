<div class='row-fluid'>
	<div class="preview">
		<%= image_tag @product.photos.preview, :id => 'zoom_01', "data-zoom-image" => "http://www.elevateweb.co.uk/wp-content/themes/radial/zoom/images/large/image3.jpg" %>
	</div>
	<script type="text/javascript">
		require(['jquery', 'lib/JNMagnifier'], function($){
			$("#zoom_01").elevateZoom();
		});
	</script>
	<div class="container-fluid property">
		<div class="row-fluid">
			<div class="span12">
			<%= link_to t(:enter_shop, :name => @product.shop.name),
						shop_path(@product.shop.name),
						:class => 'btn pull-right' %>
			<h5><%= @product.name %></h5>
			<p><small><%= @product.summary %></small></P>
			<hr>
				<%= simple_form_for @item, :url => @product, :html => {:class => 'form-horizontal' } do |f| %>
					<%= f.input :title, :as => :hidden %>
					<%= f.input :price, :as => :hidden %>
					<!-- <%= f.input :amount, :as => :hidden %> -->
					<!-- <%= f.input :product_id, :as => :hidden, :input_html => { :value => @product.id } %> -->
					<%= f.input :sub_product_id, :as => :hidden %>
					<div class="control-group">
 						<label class="control-label" for="inputEmail">价格</label>
 						<div class="controls">
							<p class="text-surprised sub-product-price"><%= @product.price %></p>
						</div>
 						<label class="control-label" for="inputEmail">配送</label>
 						<div class="controls">
							<p class="text-surprised send-product-price"><%= @product.price %></p>
						</div>
 						<label class="control-label" for="inputEmail">重量</label>
 						<div class="controls">
							<p class="text-surprised send-product-price"><%= @product.weight %></p>
						</div>
 						<label class="control-label" for="inputEmail">商品评分</label>
 						<div class="controls">
							<p class="star"></p>
							<script type="text/javascript">
								require(['jquery', 'lib/jquery.raty'], function($){
									$(".star").raty({
										readOnly : true,
										score    : 4,
										path     : "<%= asset_path 'raty' %>"
									})
								});
							</script>
						</div>
						<%= render_the_styles %>
					</div>
					<div class="control-group">
					    <label class="control-label" for="inputEmail">数量</label>
					    <div class="controls">
					    	<%= f.input :amount, :as => :spinner %>
					    	<span> 库存<span class='sub-product-quantity'><%= @product.quantity %></span>件</span>
							<!-- <div id="MySpinner" class="spinner">
						      <input type="text" class="input-mini spinner-input" maxlength="3" value='1'>
						      <div class="spinner-buttons  btn-group btn-group-vertical">
						        <button class="btn spinner-up">
						          <i class="icon-chevron-up"></i>
						        </button>
						        <button class="btn spinner-down">
						          <i class="icon-chevron-down"></i>
						        </button>
						      </div>
						    </div> -->
					    </div>
					    <!-- <label class="control-label" for="inputEmail">数量</label>
	 						<div class="controls">
								<p class="text-surprised"><%= @product.quantity %></p>
							</div> -->
				    </div>
					<div class="control-group">
						<div class="controls pull-right">
							<button class="btn btn-primary btn-large">BUY</button>
							<%= add_to_my_cart("Add To Cart", '.preview') %>
						</div>
					</div>
				<% end %>
			</div>
		</div>
	</div>
</div>

<script type='text/javascript'>
require(['jquery'], function($){
	var sub_products = [<%= sub_products %>]
	$(".style-items").click(function(){
		var that = this;
		var form = $(that).parents('form');
		var style_group = $(that).parents('.style-group');
		var siblings = $(that).siblings('.style-items')
		var selected_items = []

		active_me()
		if (all_styles_chosen()) render_data();

		//高亮选中项
		function active_me(){
			for(var i = 0; i < siblings.length; i++){
				$(siblings[i]).removeClass('active');
			}
			$(that).addClass("active");
		}

		//判断每种样式是否都有一个子项被选中
		function all_styles_chosen(){
			var groups = form.find('.style-group');
			selected_items = [];
			for(var i = 0; i < groups.length; i++){
				if (!have_item_selected(groups[i])) return false;
			}
			return true;
		}

		//判断本样式是否有一个子项被选中
		function have_item_selected(style_group){
			var items = $(style_group).children('.style-items');
			for(var i = 0; i < items.length; i++ ){
				if ($(items[i]).hasClass('active')) {
					selected_items.push($(items[i]))
					return true;
				}
			}
			return false;
		}

		//修改（填充）分商品数据（价格，库存）
		function render_data() {
			var the_object = find_the_object()
			render_the_object(the_object)
		}

		function find_the_object() {
			var the_sub = []
			for(var i = 0; i < selected_items.length; i ++) {
				if (the_sub.length == 0) the_sub = sub_products;
				var item = selected_items[i]
				var item_detail = item.attr('id').split('-')
				var html_id = '' + item_detail[0] + '_' + item_detail[1] + '_id'
				the_sub = _.filter(the_sub, function(item){
					return item[html_id] == item_detail[2]
				})
			}
			return the_sub[0]
		}

		function render_the_object(the_object) {
			var quantity = the_object['quantity'];
			var price = the_object['price'];
			var object_id = the_object['id']
			form.find('#product_item_sub_product_id').val(object_id);
			form.find('.sub-product-quantity').text(quantity);
			form.find('#product_item_price').val(price);
			form.find('.sub-product-price').text(price);
			form.find('.send-product-price').text(price);
		}

	})
})
</script>
