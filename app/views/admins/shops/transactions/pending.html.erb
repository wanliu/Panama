<% admin_active_section :pending %>

<div class='row-fluid'>
  <div class='span12'>
    <h2 class='page-title'>未处理</h2>
  </div>
</div>
<div class='row-fluid'>
  <div class='span12'>
    <section class='widget'>
      <table class='table table-striped table-images untransactions'>
        <thead>
          <tr>
            <th>订单编号</th>
            <th>买家</th>
            <th>商品数量</th>
            <th>总金额</th>
            <th>下单日期</th>
            <th>状态</th>
            <th>地址</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </section>
  </div>
</div>
<div class='row-fluid'>
  <div class='span12'>
    <h2 class='page-title'>正在处理</h2>
  </div>
</div>
<div class='row-fluid'>
  <div class='span12 direct_transactions'>
    <% @direct_tansactions.each do | dt | %>
    <%= render 'admins/shops/direct_transactions/show', :direct_transaction => dt %>
    <% end %>
  </div>
</div>
<div class='row-fluid'>
  <div class='span12 transaction_list'>
    <% @transactions.each do |transaction| %>
        <%= render :partial => "transaction" ,:locals => {
            :transaction => transaction,
            state: transaction.state,
            people: current_user } %>
    <% end %>
  </div>
  <script type="text/javascript">
    var transactionCard = function(elem){
      var card = new ShopTransactionCard({
        el: elem,
        realtime: {
          url: '<%= faye_server_uri %>',
          token: '<%= token %>'
        }
      })
    }

    $(".transaction").each(function(i, elem){
      transactionCard(elem)
    });

    var dispose_view = new TransactionDispose({
      el: $("table.untransactions"),
      realtime_url: '<%= faye_server_uri %>',
      shop: {
        name: "<%=current_shop.name %>",
        id: "<%=current_shop.id %>",
        token: "<%=current_shop.im_token %>"},

      tranOpts: {
        transactions: {
          tran_panel: $(".transaction_list"),
          tran_card: transactionCard
        },
        direct_transactions:{
          tran_panel: $(".direct_transactions"),
          tran_card: function(ele){}
        }
      },
      template: Hogan.compile("<%=j render :partial => 'untransaction' %>")
    })

    <% @undirect_tansactions.each do |ut| %>
      dispose_view.add({
        id: <%=ut.id %>,
        number: "<%= ut.number %>",
        buyer_login: "<%=ut.buyer.login %>",
        items_count: "<%=ut.items_count %>",
        total: "<%=ut.total %>",
        created_at: "<%=ut.created_at.strftime('%Y-%m-%d %H:%M:%S') %>",
        state_title: '<%=t("direct_transaction_state.#{ut.state.name}") %>',
        address: "",
        unmessages_count: "<%=ut.unmessages.count %>",
        _type: "direct_transactions"
      })
    <% end %>

    <% @untransactions.each do |t| %>
      dispose_view.add({
        id: <%=t.id %>,
        number: "<%= t.number %>",
        buyer_login: "<%=t.buyer.login %>",
        items_count: "<%=t.items_count %>",
        total: "<%=t.total %>",
        created_at: "<%=t.created_at.strftime('%Y-%m-%d %H:%M:%S') %>",
        state_title: '<%=t("order_states.seller.#{t.state}") %>',
        address: "<%=t.address.try(:location) %>",
        unmessages_count: "<%=t.unmessages.count %>",
        _type: "transactions"
      })
    <% end %>

    new TransactionBubbling({
      url: "http://<%=request.env['HTTP_HOST'] %>/shops/<%=current_shop.name %>/admins/pending#order"
    })

    $(".direct_transactions>.direct").each(function(i, elem){
      new ShopDirectTransactionView({el: $(elem)})
    })
  </script>
</div>

