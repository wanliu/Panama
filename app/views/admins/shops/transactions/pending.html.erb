<% admin_active_section :pending %>

<div class='row-fluid'>
  <div class='span12'>
    <h3 class='page-title'>未处理</h3>
  </div>
</div>
<div class='row-fluid'>
  <div class='span12'>
    <section class='widget'>
      <table class='table table-striped table-images untransactions'>
        <thead>
          <tr>
            <th>订单编号</th>
            <th>买家</th>
            <th>商品数量</th>
            <th>总金额</th>
            <th>下单日期</th>
            <th>状态</th>
            <th>地址</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </section>
  </div>
</div>
<div class='row-fluid'>
  <div class='span12'>
    <h3 class='page-title'>正在处理</h3>
  </div>
</div>
<div class='row-fluid transaction-list'>
  <div class='span12'>
    <div class='widget'>
      <div class='row-fluid'>
        <div class='span7'>
          <div class='span7'>
            商品
          </div>
          <div class='span3'>
            单价
          </div>
          <div class='span2'>
            数量
          </div>
        </div>
        <div class='span2'>
          合计
        </div>
        <div class='span2'>
          状态
        </div>
        <div class='span1'>
          操作
        </div>
      </div>
      <% if @transactions.length > 0 %>
        <% @transactions.each do |t| %>
        <div class='item' id="order_transaction<%=t.id %>" data-value-id="<%=t.id %>">
          <div class='summarize'>
            <div class='row-fluid head'>
              <div class='span3'>
                编号: <%=t.number %>
              </div>
              <div class='span4'>
                在
                <small rel='tooltip' title="<%=I18n.l t.created_at, :format => :long %>">
                  <%= time_ago_in_words t.created_at %>
                </small>
                之前交易
              </div>
              <div class='span2'>
                <%= link_to t.seller.name, shop_path(t.seller)  %>
              </div>
            </div>
            <div class='row-fluid products'>
              <div class='span7'>
                <% t.items.each do |item| %>
                <%=render_funcat "product_item", :item => item %>
                <% end %>
              </div>
              <div class='span2'>
                <div>
                  <%=number_to_currency t.stotal %>
                </div>
                <div class='delivery_price'>
                  (含<%=t.delivery_price || 0 %>运费)
                </div>
              </div>
              <div class='span2'>
                <%=t.state_title %>
              </div>
              <div class='span1'>
                <% if t.close_state? %>
                <a href='javascript:void(0)' class='btn_delete'>
                  删除
                </a>
                <% end %>
              </div>
            </div>
          </div>
          <div class='detail'>
          </div>
        </div>
        <% end %>
      <% else %>
        <div class='row-fluid'>
          <div class='span12 widget'>
            暂时没有订单
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
<%= paginate @transactions %>

<script type="text/javascript">
  $(function(){

    var transactionCard = function(elem){
      var card = new ShopTransactionCard({
        el: elem,
        realtime: {
          url: '<%= faye_server_uri %>',
          token: '<%= token %>'
        },
        shop: {
          token: "<%=current_shop.im_token %>"
        }
      })
    }

    var view = new TableListView({
      el: $(".transaction-list"),
      remote_url: "<%= shop_admins_transactions_path(current_shop) %>",
      bindView: function(view){
        transactionCard(view.$(".detail .transaction"))
      }
    })

    var dispose_view = new TransactionDispose({
      el: $("table.untransactions"),
      realtime_url: '<%= faye_server_uri %>',
      shop: {
        name: "<%= current_shop.name %>",
        id: "<%= current_shop.id %>",
        token: "<%= current_shop.im_token %>"},
      tranOpts: {
        transactions: {
          tran_panel: $(".transaction_list"),
          tran_card: transactionCard
        }
      },
      template: Hogan.compile("<%= j render :partial => 'untransaction' %>")
    })

    dispose_view.add_orders(<%= @untransactions.as_json.to_json.html_safe %>)

    new TransactionBubbling({
      url: "http://<%= request.env['HTTP_HOST'] %>/shops/<%= current_shop.name %>/admins/pending#order"
    })
  })
</script>