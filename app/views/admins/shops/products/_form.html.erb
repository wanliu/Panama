<%= simple_form_for @product,
    :url => admins_products(@product),
    :remote => true,
    :html => {
        :class => "form-horizontal"
    } do |f| %>
    <%= f.input :name %>
    <div class="control-group string required">
        <label class="string required control-label" for="product_name"><abbr title="required">*</abbr> 类别</label>
        <div class="controls">
            <%= breadcrumb_button(dom_id(@product, :category), @product.category_ancestors_and_self ) %>

            <script type="text/javascript">
                function getBrowserHeight(){ 
                    if($.browser.msie){ 
                        return document.compatMode == "CSS1Compat"? document.documentElement.clientHeight : document.body.clientHeight; 
                    } 
                    else { 
                        return self.innerHeight; 
                    } 
                } 

                function scrollVertical(div_id) {
                    if (document.getElementById('div_id')) {
                        function scrollVertically(e) {
                            e = window.event || e;
                            var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));
                            document.getElementById('div_id').scrollHeight -= (delta*40); // Multiplied by 40
                            e.preventDefault();
                        }
                        if (document.getElementById('div_id').addEventListener) {
                            // IE9, Chrome, Safari, Opera
                            document.getElementById('div_id').addEventListener("mousewheel", scrollVertically, false);
                            // Firefox
                            document.getElementById('div_id').addEventListener("DOMMouseScroll", scrollVertically, false);
                        } else {
                            // IE 6/7/8
                            document.getElementById('div_id').attachEvent("onmousewheel", scrollVertically);
                        }
                    }
                }

                var button = ".<%= dom_id(@product, :category) %>";

                require(['jquery', 'twitter/bootstrap/modal'], function($){
                    var dialog_base_top = 0;
                    var window_top = 0;
                    var scrollDialog = function(e){
                        dialog_base_top = parseInt($("#CategoryModal").css('top'));
                        scroll_top = dialog_base_top + (e.wheelDelta);

                        screen_height = getBrowserHeight(); 
                        dialog_height = $("#CategoryModal").height();
                        dialog_top = $("#CategoryModal").offset().top; 
                        dialog_bottom = dialog_top + dialog_height;

                        if ((e.wheelDelta > 0 && dialog_top < 0)||(e.wheelDelta < 0 && dialog_bottom > screen_height)) {
                            $("#CategoryModal").css('top', scroll_top);
                        }
                        
                        e = e || window.event;
                        if (e.preventDefault)
                            e.preventDefault();
                        e.returnValue = false;

                    };
                    

                    $("#CategoryModal").on('show', function() {
                        dialog_base_top = $(this).position().top;
                        window_top = $(window).scrollTop();
                        $(this)
                            .find(".modal-body")
                            .load("<%= category_page_shop_admins_products_path %>");

                        // debugger
                        window.onmousewheel = document.onmousewheel = scrollDialog;
                    });


                    $("#CategoryModal").on('hide', function(){
                        window.onmousewheel = document.onmousewheel = undefined;
                    });

                    $(button).click(function(e){
                        $('#CategoryModal').modal('show');
                    });
                })
            </script>
        </div>
    </div>

    <%= f.association :shops_category, :as => :chosen %>
    <%= f.association :attachments,
                      :as           => :album,
                      :upload_url   => shop_admins_attachments_path(current_shop),
                      :collection   => @product.format_attachment %>

		<%= render_styles %>

    <%= f.input :price %>
    <%#= f.association :category, :collection => category_root, :value => Category.root , :as => :columnview %>
    <%= f.input :summary , as: :text %>
    <%= f.button :submit, :save %>

    <%= link_to_if(@product.new_record?, :cancel, '#', :class => 'btn cancel') do
        link_to :close, '#', :class => 'btn close'
    end %>
<% end %>


<%= register_javascript :product_form_editor, :only => :ajax do %>
<script type="text/javascript">

	require(['lib/table_bander'], function(tblBander){
		var bander = new tblBander.TableBander({
			// els : [$('div.colours'), $('div.sizes')],
			els    : [<%= filter_attribtues.map{ |item| "$('div.#{item.downcase}')" }.join(', ').html_safe %>],
			fields : [{title: '价格', value: 'price'}, {title: '数量', value: 'quantity'}],
			depth  : ['colour', 'size']
		})
	})

	<%= data_2_talbe %>

	require(['lib/colorpicker/js/bootstrap-colorpicker'], function(){
    $('.color').colorpicker();
  })

    require(['jquery', 'backbone', 'rails.view', 'nested_form'], function($, Backbone, Rails){
        var form = new Rails.FormView("form#<%= options_dom_id(@product) %>", {
            model: <%= raw @product.to_json %>
        });
    })

</script>
<% end %>

<!-- Modal -->
<div id="CategoryModal" class="modal hide fade in" style="position: absolute" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="false">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">产品类型</h3>
  </div>
  <div class="modal-body">
    <p>One fine body…</p>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">取消</button>
    <button class="btn btn-primary">保存</button>
  </div>
</div>